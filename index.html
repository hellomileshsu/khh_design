<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>拍完才疊圖（iPhone Safari / MP4 下載）</title>
<style>
  html, body { 
    margin: 0; 
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
    background: #2d3748;
  }
  
  .stage { 
    display: flex; 
    flex-direction: column; 
    height: 100vh;
    width: 100vw;
    position: relative;
  }
  
  /* 首頁樣式 */
  .home-page {
    background: #f5f5f5;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
  }
  
  .home-title {
    font-size: 28px;
    font-weight: bold;
    color: #e53e3e;
    margin-bottom: 20px;
  }
  
  .main-display {
    width: 280px;
    height: 500px;
    background: white;
    border: 2px solid #ddd;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 40px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .enter-btn {
    background: #4a5568;
    color: white;
    border: none;
    padding: 16px 60px;
    font-size: 18px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 500;
  }
  
  .enter-btn:hover {
    background: #2d3748;
  }
  
  /* 相機頁面樣式 */
  .camera-page {
    background: #2d3748;
    color: white;
    display: none;
  }
  
  .camera-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  .camera-display {
    width: 90%;
    max-width: 350px;
    height: 600px;
    background: #000;
    border: 3px solid #4a5568;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    margin-bottom: 40px;
  }
  
  .camera-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #e53e3e;
    font-size: 16px;
    z-index: 10;
  }
  
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .record-btn {
    width: 80px;
    height: 80px;
    background: #e53e3e;
    border: none;
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .record-btn:hover {
    transform: scale(1.1);
  }
  
  .record-btn:disabled {
    background: #666;
    cursor: not-allowed;
    transform: none;
  }
  
  .record-btn.recording {
    background: #c53030;
    animation: pulse 1s infinite;
    border-radius: 12px;
    width: 60px;
    height: 60px;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  /* 預覽/出圖頁面樣式 */
  .preview-page {
    background: #2d3748;
    color: white;
    display: none;
    min-height: 100vh;
  }
  
  .preview-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
    box-sizing: border-box;
  }
  
  .preview-display {
    width: 90%;
    max-width: 350px;
    aspect-ratio: 9/16;
    background: #000;
    border: 3px solid #4a5568;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .preview-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #e53e3e;
    font-size: 16px;
    z-index: 10;
  }
  
  canvas {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .bottom-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 200px;
    margin-top: 20px;
    margin-bottom: 20px;
  }
  
  .save-btn, .back-btn {
    background: #4a5568;
    color: white;
    border: none;
    padding: 16px 32px;
    font-size: 16px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 500;
    width: 100%;
    position: relative;
    transition: all 0.3s ease;
  }
  
  .save-btn.saving {
    background: #666;
    cursor: not-allowed;
  }
  
  .save-btn .loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid #transparent;
    border-top: 2px solid #white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
  }
  
  .save-btn.saving .loading-spinner {
    display: inline-block;
  }
  
  .save-btn .progress-text {
    font-size: 14px;
    opacity: 0.8;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .save-btn {
    background: #4a5568;
  }
  
  .save-btn:hover {
    background: #2d3748;
  }
  
  .back-btn:hover {
    background: #2d3748;
  }
  
  /* 錄影計時器 */
  .recording-timer {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 16px;
    font-weight: bold;
    z-index: 100;
    display: none;
  }
  
  .recording-timer.active {
    display: block;
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.7; }
  }

  /* 返回按鈕（頂部） */
  .top-nav {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
  }
  
  .return-btn {
    background: #e53e3e;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    display: none;
  }
  
  .return-btn:hover {
    background: #c53030;
  }
  
  /* 隱藏默認元素 */
  .controls {
    display: none;
  }
  
  #previewCanvas, #previewSrc {
    display: none;
  }
  
  /* 響應式設計 */
  @media (max-width: 480px) {
    .main-display, .camera-display {
      width: 95%;
      height: 70vh;
    }
    
    .preview-display {
      width: 95%;
      max-width: none;
      aspect-ratio: 9/16;
    }
    
    .preview-container {
      padding: 10px;
      justify-content: flex-start;
      gap: 20px;
    }
    
    .home-title {
      font-size: 24px;
    }
    
    .enter-btn {
      padding: 14px 40px;
      font-size: 16px;
    }
    
    .bottom-controls {
      width: 90%;
      margin-top: 10px;
      margin-bottom: 10px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    /* 確保手機版畫面不會超出螢幕 */
    .stage {
      height: 100vh;
      overflow: hidden;
    }
  }
</style>
</head>
<body>
  <div class="stage">
    <!-- 首頁 -->
    <div id="homePage" class="home-page">
      <div class="main-display">
        <span style="color: #e53e3e;">主視覺</span>
      </div>
      <button class="enter-btn" onclick="enterCamera()">進入</button>
    </div>

    <!-- 相機頁面 -->
    <div id="cameraPage" class="camera-page">
      <div class="recording-timer" id="recordingTimer">00:00</div>
      <div class="camera-container">
        <div class="camera-display">
          <div class="camera-label">相機畫面</div>
          <video id="camera" autoplay playsinline muted></video>
        </div>
        <button id="recordBtn" class="record-btn" onclick="toggleRecording()"></button>
      </div>
    </div>

    <!-- 預覽/出圖頁面 -->
    <div id="previewPage" class="preview-page">
      <div class="preview-container">
        <div class="preview-display">
          <div class="preview-label">出圖</div>
          <canvas id="previewCanvas"></canvas>
        </div>
        <div class="bottom-controls">
          <button class="save-btn" onclick="saveVideo()">
            <span class="loading-spinner"></span>
            <span class="save-text">儲存</span>
            <div class="progress-text" style="display: none;"></div>
          </button>
          <button class="back-btn" onclick="backToCamera()">返回</button>
        </div>
      </div>
    </div>

    <!-- 隱藏的元素 -->
    <video id="previewSrc" style="display:none;" playsinline></video>
    <div class="controls" style="display:none;">
      <button id="startBtn">開始錄影</button>
      <button id="stopBtn" disabled>停止錄影</button>
      <button id="saveBtn" style="display:none;">儲存（MP4）</button>
    </div>
  </div></body>

<script src="gifler.min.js"></script>
<script>
// UI 元素
const homePage = document.getElementById('homePage');
const cameraPage = document.getElementById('cameraPage');
const previewPage = document.getElementById('previewPage');

const camera = document.getElementById('camera');
const previewSrc = document.getElementById('previewSrc');
const previewCanvas = document.getElementById('previewCanvas');
const pctx = previewCanvas.getContext('2d');

const recordBtn = document.getElementById('recordBtn');
const recordingTimer = document.getElementById('recordingTimer');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const saveBtn  = document.getElementById('saveBtn');

let mediaRecorder;
let recordedChunks = [];
let rafId;
let isRecording = false;
let recordingStartTime = 0;
let timerInterval = null;

// 頁面切換功能
function showPage(pageToShow) {
  homePage.style.display = 'none';
  cameraPage.style.display = 'none';
  previewPage.style.display = 'none';
  
  pageToShow.style.display = 'flex';
}

function enterCamera() {
  showPage(cameraPage);
  
  // 顯示相機畫面並隱藏標籤
  camera.style.display = 'block';
  const cameraLabel = document.querySelector('.camera-label');
  if (cameraLabel && camera.srcObject) {
    cameraLabel.style.display = 'none';
  }
}

function returnHome() {
  showPage(homePage);
  // 停止錄影（如果正在錄影）
  if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.classList.remove('recording');
    stopTimer();
  }
}

function backToCamera() {
  showPage(cameraPage);
}

function goToPreview() {
  showPage(previewPage);
}

// 計時器功能
function startTimer() {
  recordingStartTime = Date.now();
  recordingTimer.classList.add('active');
  
  timerInterval = setInterval(() => {
    const elapsed = Date.now() - recordingStartTime;
    const seconds = Math.floor(elapsed / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    
    const timeString = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    recordingTimer.textContent = timeString;
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  recordingTimer.classList.remove('active');
  recordingTimer.textContent = '00:00';
}

// 錄影切換功能
function toggleRecording() {
  if (!isRecording) {
    startRecording();
  } else {
    stopRecording();
  }
}

function startRecording() {
  recordedChunks = [];
  isRecording = true;
  recordBtn.classList.add('recording');
  startTimer();
  
  // 使用原有的錄影邏輯
  const tryTypes = [
    'video/mp4;codecs=avc1.42E01E',
    'video/mp4;codecs=h264',
    'video/mp4'
  ];
  let options = {};
  for (const t of tryTypes) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
      options = { mimeType: t };
      break;
    }
  }
  try {
    mediaRecorder = new MediaRecorder(camera.srcObject, options);
  } catch {
    mediaRecorder = new MediaRecorder(camera.srcObject);
  }

  mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/mp4' });
    previewSrc.src = URL.createObjectURL(blob);
    if (previewSrc.readyState >= 1) {
      startOverlayPreview();
      goToPreview();
    } else {
      previewSrc.onloadedmetadata = () => {
        startOverlayPreview();
        goToPreview();
      };
    }
  };

  mediaRecorder.start();
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.classList.remove('recording');
    stopTimer();
  }
}

function saveVideo() {
  const saveBtnElement = document.querySelector('.save-btn');
  const saveText = saveBtnElement.querySelector('.save-text');
  const progressText = saveBtnElement.querySelector('.progress-text');
  
  // 顯示載入狀態
  saveBtnElement.classList.add('saving');
  saveText.textContent = '準備中...';
  progressText.style.display = 'block';
  progressText.textContent = '0%';
  
  // 使用原有的儲存邏輯（觸發原本的 saveBtn 點擊）
  saveBtn.click();
}

// Gifler GIF 動畫播放器
class GifAnimationPlayer {
  constructor(gifPath) {
    this.gifPath = gifPath;
    this.isLoaded = false;
    this.animationCanvas = document.createElement('canvas');
    this.animationCtx = this.animationCanvas.getContext('2d');
    this.currentFrame = null;
    
    this.loadGif();
  }
  
  async loadGif() {
    console.log('開始載入 GIF:', this.gifPath);
    
    try {
      // 檢查 gifler 是否可用
      if (typeof gifler === 'undefined') {
        throw new Error('gifler 庫未載入');
      }
      
      // 使用 gifler 載入和播放 GIF
      gifler(this.gifPath).frames(this.animationCanvas, (ctx, frame) => {
        // 每一幀的回調函數
        if (!this.isLoaded) {
          this.animationCanvas.width = frame.width;
          this.animationCanvas.height = frame.height;
          this.isLoaded = true;
          console.log('GIF 載入成功，尺寸:', frame.width, 'x', frame.height);
        }
        
        // 清除並繪製當前幀
        ctx.clearRect(0, 0, this.animationCanvas.width, this.animationCanvas.height);
        ctx.drawImage(frame.buffer, 0, 0);
        this.currentFrame = frame;
      });
      
    } catch (error) {
      console.error('GIF 載入失敗:', error);
      this.loadAsImage();
    }
  }
  
  loadAsImage() {
    // 備用方案：靜態圖片
    console.log('回退到靜態圖片模式');
    const img = new Image();
    img.onload = () => {
      this.isLoaded = true;
      this.staticImage = img;
      console.log('使用靜態圖片作為備用:', img.width, 'x', img.height);
    };
    img.onerror = () => {
      console.error('靜態圖片載入也失敗');
    };
    img.src = this.gifPath;
  }
  
  draw(ctx, x, y, width, height) {
    if (!this.isLoaded) return;
    
    ctx.save();
    
    if (this.currentFrame && this.animationCanvas.width > 0) {
      // 繪製當前動畫幀
      ctx.drawImage(this.animationCanvas, x, y, width, height);
    } else if (this.staticImage && this.staticImage.complete) {
      // 繪製靜態圖片
      ctx.drawImage(this.staticImage, x, y, width, height);
    }
    
    ctx.restore();
  }
}

// 初始化 GIF 播放器（使用 tenor.gif）
const gifPlayer = new GifAnimationPlayer('tenor.gif');

// 動畫時間變數
let overlayAnimationTime = 0;

// GIF 動畫覆蓋層函數
function drawGifOverlay(ctx, width, height) {
  // 背景文字
  ctx.save();
  ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
  ctx.font = `${Math.min(width, height) * 0.06}px Arial, sans-serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('What is Kaohsiung', width / 2, height * 0.8);
  ctx.restore();
  
  // 繪製 GIF 動畫 (覆蓋整個畫面)
  if (gifPlayer.isLoaded) {
    gifPlayer.draw(ctx, 0, 0, width, height);
  }
}

// 1) 啟動相機（iPhone Safari：記得 https 網站/本機用 file:// 可能不行）
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
  .then(stream => { 
    camera.srcObject = stream;
    // 相機啟動後隱藏標籤
    const cameraLabel = document.querySelector('.camera-label');
    if (cameraLabel) {
      camera.addEventListener('loadedmetadata', () => {
        cameraLabel.style.display = 'none';
      });
    }
  })
  .catch(err => alert("無法開啟相機: " + err.message));

// 2) 開始錄影：純相機串流（不加圖）
startBtn.onclick = () => {
  recordedChunks = [];

  // iOS Safari 通常會輸出 mp4，就算不指定 mimeType 也 OK
  const tryTypes = [
    'video/mp4;codecs=avc1.42E01E',
    'video/mp4;codecs=h264',
    'video/mp4'
  ];
  let options = {};
  for (const t of tryTypes) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
      options = { mimeType: t };
      break;
    }
  }
  try {
    mediaRecorder = new MediaRecorder(camera.srcObject, options);
  } catch {
    mediaRecorder = new MediaRecorder(camera.srcObject); // 讓瀏覽器自選
  }

  mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'video/mp4' });
    previewSrc.src = URL.createObjectURL(blob);
    if (previewSrc.readyState >= 1) startOverlayPreview();
    else previewSrc.onloadedmetadata = startOverlayPreview;
  };

  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled  = false;
};

// 3) 停止錄影
stopBtn.onclick = () => {
  mediaRecorder.stop();
  stopBtn.disabled  = true;
  startBtn.disabled = false;
};

// 4) 停錄後：顯示「有疊圖」預覽（畫在 canvas 上）
function startOverlayPreview() {
  console.log('開始預覽，視頻尺寸:', previewSrc.videoWidth, 'x', previewSrc.videoHeight);
  
  // 等待視頻載入完成
  const setupPreview = () => {
    // 設置 canvas 尺寸為影片的原始尺寸
    const videoWidth = previewSrc.videoWidth || 720;
    const videoHeight = previewSrc.videoHeight || 1280;
    
    previewCanvas.width = videoWidth;
    previewCanvas.height = videoHeight;
    
    console.log('Canvas 尺寸設置為:', previewCanvas.width, 'x', previewCanvas.height);
    console.log('影片比例:', (videoWidth / videoHeight).toFixed(2));

    // 顯示 canvas 並隱藏標籤
    previewCanvas.style.display = 'block';
    const previewLabel = document.querySelector('.preview-label');
    if (previewLabel) previewLabel.style.display = 'none';
    
    previewSrc.currentTime = 0;
    previewSrc.play();

    const render = () => {
      if (previewSrc.ended || previewSrc.paused) { 
        rafId && cancelAnimationFrame(rafId);
        // 影片結束時重新播放
        if (previewSrc.ended) {
          previewSrc.currentTime = 0;
          previewSrc.play();
        }
        return; 
      }
      
      // 清除畫布
      pctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
      
      // 先畫影片
      try {
        pctx.drawImage(previewSrc, 0, 0, previewCanvas.width, previewCanvas.height);
      } catch(e) {
        console.error('繪製視頻時出錯:', e);
      }
      
      // 再畫 GIF 動畫覆蓋層
      drawGifOverlay(pctx, previewCanvas.width, previewCanvas.height);
      
      rafId = requestAnimationFrame(render);
    };
    
    rafId && cancelAnimationFrame(rafId);
    render();
  };

  // 確保視頻已載入元數據
  if (previewSrc.readyState >= 1) {
    setupPreview();
  } else {
    previewSrc.addEventListener('loadedmetadata', setupPreview, { once: true });
  }
}

// 5) 按「儲存」：把 canvas（預覽畫面）錄成影片，並「直接觸發下載」
//    說明：為了相容 iPhone Safari，這裡預設不含音訊；格式盡量用 MP4。
saveBtn.onclick = async () => {
  const saveBtnElement = document.querySelector('.save-btn');
  const saveText = saveBtnElement.querySelector('.save-text');
  const progressText = saveBtnElement.querySelector('.progress-text');
  
  // 更新進度狀態
  const updateProgress = (percent, status) => {
    progressText.textContent = `${percent}%`;
    saveText.textContent = status;
  };
  
  updateProgress(10, '初始化中...');
  
  // 讓來源影片再播一遍，邊播邊把畫面錄下來
  previewSrc.currentTime = 0;
  await previewSrc.play();
  
  updateProgress(20, '準備錄影...');

  const canvasStream = previewCanvas.captureStream(30); // 30fps
  // 優先 mp4
  const tryTypes = [
    'video/mp4;codecs=avc1.42E01E',
    'video/mp4;codecs=h264',
    'video/mp4'
  ];
  let recOptions = {};
  for (const t of tryTypes) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
      recOptions = { mimeType: t };
      break;
    }
  }
  let outRecorder;
  try {
    outRecorder = new MediaRecorder(canvasStream, recOptions);
  } catch {
    outRecorder = new MediaRecorder(canvasStream); // 讓瀏覽器自選（iOS 多半仍會給 mp4）
  }

  updateProgress(30, '開始錄影...');

  const outChunks = [];
  outRecorder.ondataavailable = e => { if (e.data && e.data.size) outChunks.push(e.data); };
  outRecorder.onstop = () => {
    updateProgress(80, '生成檔案...');
    
    // 產生 blob 後，直接「建立 a 並 click()」→ 觸發下載
    const type = outRecorder.mimeType || 'video/mp4';
    const outBlob = new Blob(outChunks, { type });
    const url = URL.createObjectURL(outBlob);

    updateProgress(90, '準備下載...');

    const a = document.createElement('a');
    a.href = url;
    a.download = 'video_with_overlay.mp4';   // iPhone Safari 會用副檔名判斷
    a.rel = 'noopener';
    // iOS 有時會忽略 download，但仍會開啟檔案頁面，可再「儲存影片」
    document.body.appendChild(a);
    a.click();
    a.remove();

    updateProgress(100, '完成！');

    // 恢復按鈕狀態
    setTimeout(() => {
      saveBtnElement.classList.remove('saving');
      saveText.textContent = '儲存';
      progressText.style.display = 'none';
    }, 1000);

    // 釋放 URL
    setTimeout(() => URL.revokeObjectURL(url), 10_000);
  };

  outRecorder.start();

  // 跟著影片長度錄完為止，並更新錄影進度
  const videoDuration = previewSrc.duration || 5; // 預設 5 秒如果無法取得長度
  const startTime = Date.now();
  
  const endWhenFinished = () => {
    if (previewSrc.ended || previewSrc.paused) {
      updateProgress(70, '處理中...');
      outRecorder.stop();
      return;
    }
    
    // 計算錄影進度 (30% - 70%)
    const elapsed = (Date.now() - startTime) / 1000;
    const recordProgress = Math.min((elapsed / videoDuration) * 40, 40); // 40% 的範圍
    const currentProgress = 30 + recordProgress;
    updateProgress(Math.floor(currentProgress), '處理中...');
    
    requestAnimationFrame(endWhenFinished);
  };
  endWhenFinished();
};
</script>
</body>
</html>